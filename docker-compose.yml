services:
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASS=${RABBITMQ_PASSWORD}
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  db:
    image: postgres:15-alpine
    container_name: postgres_db
    ports:
      - '5431:5432'
    environment:
      - POSTGRES_USER=${PG_USER}
      - POSTGRES_PASSWORD=${PG_PASSWORD}
      - POSTGRES_DB=${PG_DB}
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/01-init.sql
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER} -d ${PG_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  tasks-seeder:
    build: src
    depends_on:
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_healthy
    volumes:
      - .:/app
      - ./data:/app/data
    env_file:
      - .env
    command: python src/consumer/main.py
    restart: no

  celery:
    build: src
    container_name: celery
    command: celery -A src.worker.tasks worker --loglevel=info --concurrency=1 --pool=solo
    volumes:
      - .:/app
      - ./models:/app/models
    env_file:
      - .env
    depends_on:
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_healthy
    restart: unless-stopped

  flower:
    image: mher/flower:latest
    container_name: flower
    ports:
      - "5555:5555"
    command: celery flower --port=5555
    environment:
      - CELERY_BROKER_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672//
      - FLOWER_PORT=5555
      - FLOWER_BROKER_API_URL=http://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:15672/api/
    depends_on:
      - rabbitmq
      - db
    restart: unless-stopped
volumes:
  postgres_data: